# Диаграмма процесса авторизации Jira

```
┌─────────────────┐    /auth     ┌─────────────────┐
│   Telegram Bot  │ ────────────► │  Auth Server    │
│                 │               │                 │
│ 1. Пользователь │               │ 2. Генерирует   │
│    отправляет   │               │    auth URL и   │
│    /auth        │               │    возвращает   │
│                 │               │    JSON ответ   │
└─────────────────┘               └─────────────────┘
         │                                 │
         │ JSON response                   │
         │ {auth_url: "...",               │
         │  telegram_user_id: "123"}       │
         ▼                                 │
┌─────────────────┐               ┌─────────────────┐
│   Telegram Bot  │               │      Jira       │
│                 │               │                 │
│ 3. Показывает   │               │ 4. Показывает   │
│    кнопку с     │               │    форму        │
│    auth_url     │               │    авторизации  │
└─────────────────┘               └─────────────────┘
         │                                 │
         │ пользователь нажимает кнопку    │
         ▼                                 │
┌─────────────────┐               ┌─────────────────┐
│   Web Browser   │ ◄─────────────│      Jira       │
│                 │               │                 │
│ 6. Пользователь │               │ 5. Показывает   │
│    авторизуется │               │    форму        │
│    в Jira       │               │    авторизации  │
└─────────────────┘               └─────────────────┘
                                           │
                                           │ callback
                                           ▼
┌─────────────────┐               ┌─────────────────┐
│   Auth Server   │ ◄─────────────│      Jira       │
│                 │               │                 │
│ 8. Получает     │               │ 7. Отправляет   │
│    code + state │               │    code + state │
│    с telegram_id│               │    (telegram_id)│
└─────────────────┘               └─────────────────┘
         │
         │ exchange code for token
         ▼
┌─────────────────┐
│      Jira       │
│                 │
│ 9. Обменивает   │
│    code на      │
│    access_token │
└─────────────────┘
         │
         │ token response
         ▼
┌─────────────────┐
│   Auth Server   │
│                 │
│ 10. Шифрует и   │
│     сохраняет   │
│     токен для   │
│     telegram_id │
└─────────────────┘
         │
         │ success page
         ▼
┌─────────────────┐
│   Web Browser   │
│                 │
│ 11. Показывает  │
│     успех и     │
│     закрывается │
└─────────────────┘

┌─────────────────┐    /brief     ┌─────────────────┐
│   Telegram Bot  │ ────────────► │  Auth Server    │
│                 │               │                 │
│ 10. Пользователь│               │ 11. Проверяет   │
│     использует  │               │     авторизацию │
│     /brief      │               │     по telegram_id│
└─────────────────┘               └─────────────────┘
         │
         │ если авторизован
         ▼
┌─────────────────┐
│   Telegram Bot  │
│                 │
│ 12. Выполняет   │
│     команду с   │
│     токеном     │
└─────────────────┘
```

## Ключевые моменты передачи telegram_user_id:

### 1. В параметре `state` OAuth flow:
```
/auth/start?telegram_user_id=123456789
↓
state = "telegram_user_123456789"
↓
/auth/callback?code=xxx&state=telegram_user_123456789
```

### 2. Безопасность:
- `state` параметр предотвращает CSRF атаки
- Telegram ID передается только в `state`, не в URL
- Токены шифруются перед сохранением

### 3. Альтернативные способы передачи ID:

**Вариант A: В scope (не рекомендуется)**
```
scope=read:jira-work%20write:jira-work%20telegram_user_123456789
```

**Вариант B: В redirect_uri (не рекомендуется)**
```
redirect_uri=http://localhost:5000/auth/callback?telegram_user_id=123456789
```

**Вариант C: В state (рекомендуется) ✅**
```
state=telegram_user_123456789
```

## Рекомендуемый подход:

Использовать параметр `state` для передачи `telegram_user_id`, так как:
1. Это стандартный способ OAuth 2.0
2. Предотвращает CSRF атаки
3. Не нарушает стандарт OAuth
4. Легко извлекается в callback
